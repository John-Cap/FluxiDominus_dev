'''
{
  "3f6e37eb-40ee-4ed3-862e-d9800cd0c43e": {
    "name": "R4 Pump A",
    "flowsInto": [
      "tubing_1_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
    ],
    "deviceName": "vapourtecR4P1700",
    "deviceType": "Pump",
    "volume": 5
  },
  "tubing_1_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9": {
    "name": "Tubing",
    "flowsInto": [
      "29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "11aff382-a458-4a25-a311-db62c3c45843": {
    "name": "SR_A",
    "flowsInto": [
      "tubing_2_11aff382-a458-4a25-a311-db62c3c45843_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e"
    ],
    "deviceName": "null",
    "deviceType": "Valve",
    "volume": 0.25
  },
  "tubing_2_11aff382-a458-4a25-a311-db62c3c45843_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e": {
    "name": "Tubing",
    "flowsInto": [
      "3f6e37eb-40ee-4ed3-862e-d9800cd0c43e"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "ad33a7da-5b9d-4963-b9b3-9ed61d029bd2": {
    "name": "AllylIsoval",
    "flowsInto": [
      "tubing_3_ad33a7da-5b9d-4963-b9b3-9ed61d029bd2_11aff382-a458-4a25-a311-db62c3c45843"
    ],
    "deviceName": "null",
    "deviceType": "FlowOrigin",
    "volume": 0
  },
  "tubing_3_ad33a7da-5b9d-4963-b9b3-9ed61d029bd2_11aff382-a458-4a25-a311-db62c3c45843": {
    "name": "Tubing",
    "flowsInto": [
      "11aff382-a458-4a25-a311-db62c3c45843"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "e76868c1-4c46-4c35-be71-7cf388c4765d": {
    "name": "PushSolvent A",
    "flowsInto": [
      "tubing_4_e76868c1-4c46-4c35-be71-7cf388c4765d_11aff382-a458-4a25-a311-db62c3c45843"
    ],
    "deviceName": "null",
    "deviceType": "FlowOrigin",
    "volume": 0
  },
  "tubing_4_e76868c1-4c46-4c35-be71-7cf388c4765d_11aff382-a458-4a25-a311-db62c3c45843": {
    "name": "Tubing",
    "flowsInto": [
      "11aff382-a458-4a25-a311-db62c3c45843"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "fcd5fb07-66aa-4b21-a306-6d8a873d60d9": {
    "name": "SR_B",
    "flowsInto": [
      "tubing_5_fcd5fb07-66aa-4b21-a306-6d8a873d60d9_59e6ec63-6719-483c-8467-c5ccffa0f563"
    ],
    "deviceName": "null",
    "deviceType": "Valve",
    "volume": 0.25
  },
  "tubing_5_fcd5fb07-66aa-4b21-a306-6d8a873d60d9_59e6ec63-6719-483c-8467-c5ccffa0f563": {
    "name": "Tubing",
    "flowsInto": [
      "59e6ec63-6719-483c-8467-c5ccffa0f563"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "59e6ec63-6719-483c-8467-c5ccffa0f563": {
    "name": "R4 Pump B",
    "flowsInto": [
      "tubing_6_59e6ec63-6719-483c-8467-c5ccffa0f563_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
    ],
    "deviceName": "vapourtecR4P1700",
    "deviceType": "Pump",
    "volume": 5
  },
  "tubing_6_59e6ec63-6719-483c-8467-c5ccffa0f563_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9": {
    "name": "Tubing",
    "flowsInto": [
      "29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "5915e364-75c6-49d0-b6af-f641f7b45754": {
    "name": "KOH_sol",
    "flowsInto": [
      "tubing_7_5915e364-75c6-49d0-b6af-f641f7b45754_fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
    ],
    "deviceName": "null",
    "deviceType": "FlowOrigin",
    "volume": 0
  },
  "tubing_7_5915e364-75c6-49d0-b6af-f641f7b45754_fcd5fb07-66aa-4b21-a306-6d8a873d60d9": {
    "name": "Tubing",
    "flowsInto": [
      "fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "f926cf59-bfbc-4a69-9d52-e63d58f0d695": {
    "name": "PushSolventB",
    "flowsInto": [
      "tubing_8_f926cf59-bfbc-4a69-9d52-e63d58f0d695_fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
    ],
    "deviceName": "null",
    "deviceType": "FlowOrigin",
    "volume": 0
  },
  "tubing_8_f926cf59-bfbc-4a69-9d52-e63d58f0d695_fcd5fb07-66aa-4b21-a306-6d8a873d60d9": {
    "name": "Tubing",
    "flowsInto": [
      "fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "29b52a6f-8bb5-41c0-baa8-3bab6d685ae9": {
    "name": "StaticMixer",
    "flowsInto": [
      "tubing_9_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9_d25f31e2-002b-48c7-b060-992d321ed9c4"
    ],
    "deviceName": "null",
    "deviceType": "TPiece",
    "volume": 0.05
  },
  "tubing_9_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9_d25f31e2-002b-48c7-b060-992d321ed9c4": {
    "name": "Tubing",
    "flowsInto": [
      "d25f31e2-002b-48c7-b060-992d321ed9c4"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "d25f31e2-002b-48c7-b060-992d321ed9c4": {
    "name": "Hotcoil_1",
    "flowsInto": [
      "tubing_10_d25f31e2-002b-48c7-b060-992d321ed9c4_fdcc2834-213b-42f7-bdde-b38e6a5c8172"
    ],
    "deviceName": "hotcoil1",
    "deviceType": "Coil",
    "volume": 40
  },
  "tubing_10_d25f31e2-002b-48c7-b060-992d321ed9c4_fdcc2834-213b-42f7-bdde-b38e6a5c8172": {
    "name": "Tubing",
    "flowsInto": [
      "fdcc2834-213b-42f7-bdde-b38e6a5c8172"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "fdcc2834-213b-42f7-bdde-b38e6a5c8172": {
    "name": "ReactIR 702L1",
    "flowsInto": [
      "tubing_11_fdcc2834-213b-42f7-bdde-b38e6a5c8172_e64f27b7-c346-4c86-94cd-c00398796894"
    ],
    "deviceName": "reactIR702L1",
    "deviceType": "IR",
    "volume": 0.25
  },
  "tubing_11_fdcc2834-213b-42f7-bdde-b38e6a5c8172_e64f27b7-c346-4c86-94cd-c00398796894": {
    "name": "Tubing",
    "flowsInto": [
      "e64f27b7-c346-4c86-94cd-c00398796894"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "e64f27b7-c346-4c86-94cd-c00398796894": {
    "name": "WasteOrCollect",
    "flowsInto": [
      "tubing_12_e64f27b7-c346-4c86-94cd-c00398796894_27151161-8edf-4152-9ea6-ce1df14f6f46",
      "tubing_12_e64f27b7-c346-4c86-94cd-c00398796894_f14f0372-3504-4559-ad7e-6a8661fdb7b4"
    ],
    "deviceName": "null",
    "deviceType": "Valve",
    "volume": 0.25
  },
  "tubing_12_e64f27b7-c346-4c86-94cd-c00398796894_27151161-8edf-4152-9ea6-ce1df14f6f46": {
    "name": "Tubing",
    "flowsInto": [
      "27151161-8edf-4152-9ea6-ce1df14f6f46"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "tubing_13_e64f27b7-c346-4c86-94cd-c00398796894_f14f0372-3504-4559-ad7e-6a8661fdb7b4": {
    "name": "Tubing",
    "flowsInto": [
      "f14f0372-3504-4559-ad7e-6a8661fdb7b4"
    ],
    "deviceName": "tubingStandard",
    "deviceType": "Tubing",
    "volume": 0.123
  },
  "27151161-8edf-4152-9ea6-ce1df14f6f46": {
    "name": "Product",
    "flowsInto": [],
    "deviceName": "null",
    "deviceType": "FlowTerminus",
    "volume": 0
  },
  "f14f0372-3504-4559-ad7e-6a8661fdb7b4": {
    "name": "Waste",
    "flowsInto": [],
    "deviceName": "null",
    "deviceType": "FlowTerminus",
    "volume": 0
  }
}
'''
###Example

import random
import threading
import time
from Core.Fluids.FlowPath import IR, Coil, FlowOrigin, FlowPath, FlowTerminus, Pump, Slugs, TPiece, Tubing, Valve
###Examples
if __name__ == "__main__":
    _path=FlowPath()
    comp=[]
    
    #Stocks
    _KOH_sol=FlowOrigin(volume=0,name="KOH_sol")
    comp.append(_KOH_sol)
    _allylIso=FlowOrigin(volume=0,name="AllylIsoval")
    comp.append(_allylIso)
    _push_A=FlowOrigin(volume=0,name="PushSolvent A")
    comp.append(_push_A)
    _push_B=FlowOrigin(volume=0,name="PushSolvent B")
    comp.append(_push_B)
    
    #Pump lines
    _hplc_A=Pump(volume=5,name="R4 Pump A")
    comp.append(_hplc_A)
    _hplc_B=Pump(volume=5,name="R4 Pump B")
    comp.append(_hplc_B)
    #Valves
    _SR_A=Valve(volume=0.25,name="SR_A")
    comp.append(_SR_A)
    _SR_B=Valve(volume=0.25,name="SR_B")
    comp.append(_SR_B)
    _WC_valve=Valve(volume=0.25,name="WasteOrCollect")
    comp.append(_WC_valve)
    #IR
    _IR=(IR(volume=0.25,name="ReactIR 702L1"))
    comp.append(_IR)
    #Coil
    _coil_40=(Coil(volume=5,name="Hotcoil_1")) #Smaller volume for sped up debugging
    # _coil_40=(Coil(volume=40,name="Hotcoil_1"))
    comp.append(_coil_40)
    #Termini
    _waste=FlowTerminus(volume=0,name="Waste")
    comp.append(_waste)
    _product=FlowTerminus(volume=0,name="Product")
    comp.append(_product)
    
    _tPiece_1=TPiece(volume=0.05,name="StaticMixer")
    comp.append(_tPiece_1)
    
    _tubing_1=Tubing(volume=0.123,name="TUBE_1")
    comp.append(_tubing_1)
    _tubing_2=Tubing(volume=0.123,name="TUBE_2")
    comp.append(_tubing_2)
    _tubing_3=Tubing(volume=0.123,name="TUBE_3")
    comp.append(_tubing_3)
    _tubing_4=Tubing(volume=0.123,name="TUBE_4")
    comp.append(_tubing_4)
    _tubing_5=Tubing(volume=0.123,name="TUBE_5")
    comp.append(_tubing_5)
    _tubing_6=Tubing(volume=0.123,name="TUBE_6")
    comp.append(_tubing_6)
    _tubing_7=Tubing(volume=0.123,name="TUBE_7")
    comp.append(_tubing_7)
    _tubing_8=Tubing(volume=0.123,name="TUBE_8")
    comp.append(_tubing_8)
    _tubing_9=Tubing(volume=0.123,name="TUBE_9")
    comp.append(_tubing_9)
    _tubing_10=Tubing(volume=0.123,name="TUBE_10")
    comp.append(_tubing_10)
    _tubing_11=Tubing(volume=0.123,name="TUBE_11")
    comp.append(_tubing_11)
    _tubing_12=Tubing(volume=0.123,name="TUBE_12")
    comp.append(_tubing_12)
    _tubing_13=Tubing(volume=0.123,name="TUBE_13")
    comp.append(_tubing_13)
    ###################
    #Connect components

    #Stock solutions
    _allylIso.flowInto(_tubing_3)
    _push_A.flowInto(_tubing_4)
    
    _KOH_sol.flowInto(_tubing_7)
    _push_B.flowInto(_tubing_8)
    
    _tubing_3.flowInto(_SR_A)
    _tubing_4.flowInto(_SR_A)
    
    _tubing_7.flowInto(_SR_B)
    _tubing_8.flowInto(_SR_B)
    
    #To pumps
    _SR_A.flowInto(_tubing_2)
    _tubing_2.flowInto(_hplc_A)
    
    _SR_B.flowInto(_tubing_5)
    _tubing_5.flowInto(_hplc_B)
    
    #To static mixer
    _hplc_A.flowInto(_tubing_1)
    _tubing_1.flowInto(_tPiece_1)
    
    _hplc_B.flowInto(_tubing_6)
    _tubing_6.flowInto(_tPiece_1)
    
    #From static mixer to hotcoil
    _tPiece_1.flowInto(_tubing_9)
    _tubing_9.flowInto(_coil_40)

    #To IR
    _coil_40.flowInto(_tubing_10)
    _tubing_10.flowInto(_IR)
    
    #From IR to W/C valve
    _IR.flowInto(_tubing_11)
    _tubing_11.flowInto(_WC_valve)
    
    #From W/C valve to termini
    _WC_valve.flowInto(_tubing_13)
    _tubing_13.flowInto(_waste)
    
    _WC_valve.flowInto(_tubing_12)
    _tubing_12.flowInto(_product)
    
    '''
    #Create path
    '''
    _path.addPath(comp)

    #TODO - Manually assign starting point for now
    _path.mapPathTermini()
    adrses=[str(key) for key in _path.addressesAll.keys()]
    
    print("*********************Segment details*********************")
    for _x in _path.segments:
        print(f"Comp name: {_x.name}")
        print(f" Inlet sets: {_x.inletSets}")
        print(f" Outlet sets: {_x.outletSets}")
        print(f" Curr inlets: {_x.inlets}")   
        print(f" Curr outlets: {_x.outlets}")
        print("--")
        
    print("************************Addresses*************************")
    for _x, _y in _path.addressesAll.items():
        print(f"Address for {_x}:")
        for x in _y:
            print(f" Comp: {x[0].name}")
            print(f"  Inlet set: UNDEFINED")
            print(f"  Outlet set: {x[1]}")
        print("--")
    #Some example things:
    # flowRates=[0,1,2,3,4]
    flowRates=[1]
    dispVol=[1]
    
    # Flag variable to indicate whether the thread should continue running?
    running=True
    allSlugs=Slugs()
    def run_code():
        global running
        global allSlugs
        global _path
        _i=0
        while running:
            _flow_1=random.choice(flowRates)
            _flow_2=random.choice(flowRates)
            _flow_3=random.choice(flowRates)
            _flow_4=random.choice(flowRates)
            _slugVol=random.choice(dispVol)
            
            _KOH_sol.setFlowrate(_flow_1/60)
            _allylIso.setFlowrate(_flow_2/60)
            # _push_A.setFlowrate(_flow_3/60)
            # _push_B.setFlowrate(_flow_4/60)
            _push_A.setFlowrate(0)
            _push_B.setFlowrate(0)

            _path.updateFlowrates()

            _path.setCurrDestination(random.choice(adrses))
            _slug=_path.currRelOrigin.dispense(_slugVol)
            allSlugs.slugs.append(_slug)

            _now=time.perf_counter()
            _nowRefresh=_now
            _jiggleFlowrate=time.perf_counter() + 5
            #_path.timePrev=time.perf_counter()
            while not (isinstance(_slug.tailHost,FlowTerminus)):
                # if time.time() - _jiggleFlowrate > 30:
                #     _flow_1=random.choice(flowRates)
                #     if _flow_1 == 0:
                #         _flow_1=1
                #     _flow_2=random.choice(flowRates)
                #     _flow_3=random.choice(flowRates)
                #     _flow_4=random.choice(flowRates)
                #     print("--")
                #     print(f"New flowrates: {_flow_1}, {_flow_2}, {_flow_3}, {_flow_4}")
                #     print("--")
                                        
                #     _KOH_sol.setFlowrate(_flow_1/60)
                #     _allylIso.setFlowrate(_flow_2/60)
                #     _push_A.setFlowrate(_flow_3/60)
                #     _push_B.setFlowrate(_flow_4/60)
                    
                #     _jiggleFlowrate=time.time()

                _path.advanceSlugs()
                if time.time() - _nowRefresh > 1:
                    _vol=_slug.slugVolume()
                    _nowRefresh=time.time()
                    rep=f"""--------------------------------------------------\nTime: {round(time.perf_counter() - _now, 0)} sec,\nAll fr: {[_flow_1,_flow_2,_flow_3,_flow_4]}\nFront in: {_slug.frontHost.name},\n {round(_slug.frontHost.flowrateOut*60, 2)} mL.min-1,\n {round(_slug.frontHostPos, 2)}/{_slug.frontHost.volume} mL\nTail in: {_slug.tailHost.name},\n {round(_slug.tailHost.flowrateOut*60, 2)} mL.min-1,\n {round(_slug.tailHostPos, 2)}/{_slug.tailHost.volume} mL\nslug vol: {round(_vol, 2)} mL, vol collected: {(round(_slug.collectedVol, 2))} mL"""
                    print(rep)
                time.sleep(0.1)
            print("***************************************")
            print("Collected slug volumes")
            for _x in _path.collectedSlugs:
                print(f'Slug {_x} dispensed as {_x.totalDispensed} mL from origin and collected as {_x.collectedVol} mL')
                print(f'Slug was collected at terminus "{_x.frontHost.name}"')
            print("***************************************")
            _i+=1
            if _i > 10:
                exit()
            time.sleep(10)

    # Create a thread for running the code
    thread=threading.Thread(target=run_code)
    thread.start()

    # Wait for the thread to finish
    thread.join()
    print("We're done here")

    #######################################################################################