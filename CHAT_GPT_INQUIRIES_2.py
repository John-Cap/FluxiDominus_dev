example={
  "reqUI": {
    "FlowSketcher": {
      "parseFlowsketch":{
        "3f6e37eb-40ee-4ed3-862e-d9800cd0c43e": {
          "name": "R4 Pump A",
          "flowsInto": [
            "tubing_1_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
          ],
          "deviceName": "vapourtecR4P1700",
          "deviceType": "Pump",
          "volume": 2
        },
        "tubing_1_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9": {
          "name": "Tubing",
          "flowsInto": [
            "29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "11aff382-a458-4a25-a311-db62c3c45843": {
          "name": "SR_A",
          "flowsInto": [
            "tubing_2_11aff382-a458-4a25-a311-db62c3c45843_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e"
          ],
          "deviceName": "null",
          "deviceType": "Valve",
          "volume": 0.25
        },
        "tubing_2_11aff382-a458-4a25-a311-db62c3c45843_3f6e37eb-40ee-4ed3-862e-d9800cd0c43e": {
          "name": "Tubing",
          "flowsInto": [
            "3f6e37eb-40ee-4ed3-862e-d9800cd0c43e"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "ad33a7da-5b9d-4963-b9b3-9ed61d029bd2": {
          "name": "AllylIsoval",
          "flowsInto": [
            "tubing_3_ad33a7da-5b9d-4963-b9b3-9ed61d029bd2_11aff382-a458-4a25-a311-db62c3c45843"
          ],
          "deviceName": "null",
          "deviceType": "FlowOrigin",
          "volume": 0
        },
        "tubing_3_ad33a7da-5b9d-4963-b9b3-9ed61d029bd2_11aff382-a458-4a25-a311-db62c3c45843": {
          "name": "Tubing",
          "flowsInto": [
            "11aff382-a458-4a25-a311-db62c3c45843"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "e76868c1-4c46-4c35-be71-7cf388c4765d": {
          "name": "PushSolventA",
          "flowsInto": [
            "tubing_4_e76868c1-4c46-4c35-be71-7cf388c4765d_11aff382-a458-4a25-a311-db62c3c45843"
          ],
          "deviceName": "null",
          "deviceType": "FlowOrigin",
          "volume": 0
        },
        "tubing_4_e76868c1-4c46-4c35-be71-7cf388c4765d_11aff382-a458-4a25-a311-db62c3c45843": {
          "name": "Tubing",
          "flowsInto": [
            "11aff382-a458-4a25-a311-db62c3c45843"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "fcd5fb07-66aa-4b21-a306-6d8a873d60d9": {
          "name": "SR_B",
          "flowsInto": [
            "tubing_5_fcd5fb07-66aa-4b21-a306-6d8a873d60d9_59e6ec63-6719-483c-8467-c5ccffa0f563"
          ],
          "deviceName": "null",
          "deviceType": "Valve",
          "volume": 0.25
        },
        "tubing_5_fcd5fb07-66aa-4b21-a306-6d8a873d60d9_59e6ec63-6719-483c-8467-c5ccffa0f563": {
          "name": "Tubing",
          "flowsInto": [
            "59e6ec63-6719-483c-8467-c5ccffa0f563"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "59e6ec63-6719-483c-8467-c5ccffa0f563": {
          "name": "R4 Pump B",
          "flowsInto": [
            "tubing_6_59e6ec63-6719-483c-8467-c5ccffa0f563_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
          ],
          "deviceName": "vapourtecR4P1700",
          "deviceType": "Pump",
          "volume": 2
        },
        "tubing_6_59e6ec63-6719-483c-8467-c5ccffa0f563_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9": {
          "name": "Tubing",
          "flowsInto": [
            "29b52a6f-8bb5-41c0-baa8-3bab6d685ae9"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "5915e364-75c6-49d0-b6af-f641f7b45754": {
          "name": "KOH_sol",
          "flowsInto": [
            "tubing_7_5915e364-75c6-49d0-b6af-f641f7b45754_fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
          ],
          "deviceName": "null",
          "deviceType": "FlowOrigin",
          "volume": 0
        },
        "tubing_7_5915e364-75c6-49d0-b6af-f641f7b45754_fcd5fb07-66aa-4b21-a306-6d8a873d60d9": {
          "name": "Tubing",
          "flowsInto": [
            "fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "f926cf59-bfbc-4a69-9d52-e63d58f0d695": {
          "name": "PushSolventB",
          "flowsInto": [
            "tubing_8_f926cf59-bfbc-4a69-9d52-e63d58f0d695_fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
          ],
          "deviceName": "null",
          "deviceType": "FlowOrigin",
          "volume": 0
        },
        "tubing_8_f926cf59-bfbc-4a69-9d52-e63d58f0d695_fcd5fb07-66aa-4b21-a306-6d8a873d60d9": {
          "name": "Tubing",
          "flowsInto": [
            "fcd5fb07-66aa-4b21-a306-6d8a873d60d9"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "29b52a6f-8bb5-41c0-baa8-3bab6d685ae9": {
          "name": "StaticMixer",
          "flowsInto": [
            "tubing_9_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9_d25f31e2-002b-48c7-b060-992d321ed9c4"
          ],
          "deviceName": "null",
          "deviceType": "TPiece",
          "volume": 0.05
        },
        "tubing_9_29b52a6f-8bb5-41c0-baa8-3bab6d685ae9_d25f31e2-002b-48c7-b060-992d321ed9c4": {
          "name": "Tubing",
          "flowsInto": [
            "d25f31e2-002b-48c7-b060-992d321ed9c4"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "d25f31e2-002b-48c7-b060-992d321ed9c4": {
          "name": "Hotcoil_1",
          "flowsInto": [
            "tubing_10_d25f31e2-002b-48c7-b060-992d321ed9c4_fdcc2834-213b-42f7-bdde-b38e6a5c8172"
          ],
          "deviceName": "hotcoil1",
          "deviceType": "Coil",
          "volume": 5
        },
        "tubing_10_d25f31e2-002b-48c7-b060-992d321ed9c4_fdcc2834-213b-42f7-bdde-b38e6a5c8172": {
          "name": "Tubing",
          "flowsInto": [
            "fdcc2834-213b-42f7-bdde-b38e6a5c8172"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "fdcc2834-213b-42f7-bdde-b38e6a5c8172": {
          "name": "ReactIR 702L1",
          "flowsInto": [
            "tubing_11_fdcc2834-213b-42f7-bdde-b38e6a5c8172_e64f27b7-c346-4c86-94cd-c00398796894"
          ],
          "deviceName": "reactIR702L1",
          "deviceType": "IR",
          "volume": 0.25
        },
        "tubing_11_fdcc2834-213b-42f7-bdde-b38e6a5c8172_e64f27b7-c346-4c86-94cd-c00398796894": {
          "name": "Tubing",
          "flowsInto": [
            "e64f27b7-c346-4c86-94cd-c00398796894"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "e64f27b7-c346-4c86-94cd-c00398796894": {
          "name": "WasteOrCollect",
          "flowsInto": [
            "tubing_12_e64f27b7-c346-4c86-94cd-c00398796894_27151161-8edf-4152-9ea6-ce1df14f6f46",
            "tubing_13_e64f27b7-c346-4c86-94cd-c00398796894_f14f0372-3504-4559-ad7e-6a8661fdb7b4"
          ],
          "deviceName": "null",
          "deviceType": "Valve",
          "volume": 0.25
        },
        "tubing_12_e64f27b7-c346-4c86-94cd-c00398796894_27151161-8edf-4152-9ea6-ce1df14f6f46": {
          "name": "Tubing",
          "flowsInto": [
            "27151161-8edf-4152-9ea6-ce1df14f6f46"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "tubing_13_e64f27b7-c346-4c86-94cd-c00398796894_f14f0372-3504-4559-ad7e-6a8661fdb7b4": {
          "name": "Tubing",
          "flowsInto": [
            "f14f0372-3504-4559-ad7e-6a8661fdb7b4"
          ],
          "deviceName": "tubingStandard",
          "deviceType": "Tubing",
          "volume": 0.123
        },
        "27151161-8edf-4152-9ea6-ce1df14f6f46": {
          "name": "Product",
          "flowsInto": [],
          "deviceName": "null",
          "deviceType": "FlowTerminus",
          "volume": 0
        },
        "f14f0372-3504-4559-ad7e-6a8661fdb7b4": {
          "name": "Waste",
          "flowsInto": [],
          "deviceName": "null",
          "deviceType": "FlowTerminus",
          "volume": 0
        }
      }
    }
  }
}
#######################################################################################
###Examples
import json
import random
import time
import threading

from Core.Fluids.FlowPath import FlowOrigin, FlowTerminus, Valve, visualize_flow_path

dumpNo=1
def dump_inlet_outlet_sets(path):
  global dumpNo
  for seg in path.segments:
      if seg.inletSets:
          print(f"\n[INFO #{dumpNo}] {seg.name}: Inlet Sets")
          for name, comps in seg.inletSets.items():
              print(f"  Set '{name}': {[x.name for x in comps]}")
          print(f"  Currently selected: {seg.currInletSet}")

      if seg.outletSets:
          print(f"[INFO #{dumpNo}] {seg.name}: Outlet Sets")
          for name, comps in seg.outletSets.items():
              print(f"  Set '{name}': {[x.name for x in comps]}")
          print(f"  Currently selected: {seg.currOutletSet}")
  dumpNo+=1

if __name__ == "__main__":
    from OPTIMIZATION_TEMP.Plutter_TEMP.plutter import MqttService
    
    updater = MqttService(broker_address="172.30.243.138")
    updater.connectDb=False
    updater.arm()
    updater.start()
    
    print("Waiting for connection")
    
    while not updater.connected:
      time.sleep(0.5)
    
    updater.publish("ui/FlowSketcher",json.dumps(example))
    
    print("Waiting for termini mapping")
    
    while not updater.flowSystem.flowpath.terminiMapped:
      time.sleep(1)
      
    path = updater.flowSystem.flowpath

    allSlugs = updater.flowSystem.allSlugs

    #Find component references from names
    origins = [comp for comp in path.segments if isinstance(comp,FlowOrigin)]
    
    print(f'Origins: {origins}')
    
    adrses = [name for name in path.addressesAll.keys()]
    print(f"Available addresses: \n {path.addressesAll}")

    #Some example things:
    #flowRates=[0,1,2,3,4]
    flowRates=[0.5,1,2]
    dispVol=[1]

    # path.currRelOrigin.setFlowrate(3/60)
    for orig in origins:
      orig.setFlowrate(2/60)
        
    path.dumpInletOutletSets()
    
    path.updateFlowrates()

    path.setCurrDestination(random.choice(adrses))
    
    # route=path._findPath(path._findComponentByName("KOH_sol"),path._findComponentByName("PushSolventA"))
    
    # print(f'Route to get from {path._findComponentByName("KOH_sol").name} to {path._findComponentByName("PushSolventA").name}: {[x.name for x in route]}')

    path.pullFromOrigin("AllylIsoval")
    path.pullFromOrigin("KOH_sol")
    
    path.visualizeFlowPath()
        
    slug=path.currRelOrigin.dispense(1)
    
    #Flag variable to indicate whether the thread should continue running?
    running=True
    time.sleep(1)
    
    firstSet=True
    
    def run_code():
      global running
      global allSlugs
      global slug
      global path
      global firstSet
      _i=0
      while running:

        if not firstSet:
          # path.currRelOrigin.setFlowrate(3/60)
          for orig in origins:
            orig.setFlowrate(2/60)
              
          path.dumpInletOutletSets()
          
          path.updateFlowrates()

          path.setCurrDestination(random.choice(adrses))
          slug=path.currRelOrigin.dispense(1)
          allSlugs.slugs.append(slug)
              
          dump_inlet_outlet_sets(path)
        else:
          firstSet=False
          
        _now=time.perf_counter()
        _nowRefresh=_now
        _jiggleFlowrate=time.perf_counter() + 5
        #path.timePrev=time.perf_counter()
        while not (isinstance(slug.tailHost,FlowTerminus)):
            path.advanceSlugs()
            if time.time() - _nowRefresh > 1:
                _vol=slug.slugVolume()
                _nowRefresh=time.time()
                rep=f"""--------------------------------------------------\nTime: {round(time.perf_counter() - _now, 0)} sec,\nAll fr: {[orig.flowrateOut*60 for orig in origins]}\nFront in: {slug.frontHost.name},\n {round(slug.frontHost.flowrateOut*60, 2)} mL.min-1,\n {round(slug.frontHostPos, 2)}/{slug.frontHost.volume} mL\nTail in: {slug.tailHost.name},\n {round(slug.tailHost.flowrateOut*60, 2)} mL.min-1,\n {round(slug.tailHostPos, 2)}/{slug.tailHost.volume} mL\nslug vol: {round(_vol, 2)} mL, vol collected: {(round(slug.collectedVol, 2))} mL\n Current valve states:\n {
                  [[x.name,x.inlets[0].name,x.outlets[0].name] for x in path.segments if isinstance(x,Valve)]  
                })"""
                print(rep)
            time.sleep(0.1)
        print("***************************************")
        print("Collected slug volumes")
        for _x in path.collectedSlugs:
            print(f'Slug {_x} dispensed as {_x.totalDispensed} mL from origin and collected as {_x.collectedVol} mL')
            print(f'Slug was collected at terminus "{_x.frontHost.name}"')
        print("***************************************")
        _i+=1
        if _i > 10:
            exit()
        time.sleep(10)

    # Create a thread for running the code
    thread=threading.Thread(target=run_code)
    thread.start()

    # Wait for the thread to finish
    thread.join()
    print("We're done here")

    #######################################################################################